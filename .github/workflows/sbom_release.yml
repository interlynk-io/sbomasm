name: Release | Build SBOM

on:
  release:
    types: [published]
  workflow_dispatch:

env:
  TOOL_NAME: ${{ github.repository }}
  SUPPLIER_NAME: Interlynk
  SUPPLIER_URL: https://interlynk.io
  DEFAULT_TAG: v0.0.1
  SBOM_ENV: default
  MS_SBOM_TOOL_VERSION: "4.1.3"
  MS_SBOM_TOOL_EXCLUDE_DIRS: "**/samples/**"
  PYLYNK_VERSION: "v1.0.8"

jobs:
  build-sbom:
    name: Build SBOM
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Tag
        id: get_tag
        run: echo "LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo 'v0.0.1')" >> $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Checkout Python SBOM tool
        uses: actions/checkout@v4
        with:
          repository: interlynk-io/pylynk
          ref: ${{ env.PYLYNK_VERSION }}
          path: pylynk

      - name: Install Python dependencies
        run: |
          cd pylynk
          pip install -r requirements.txt

      - name: Download and verify sbom-tool
        run: |
          curl -Lo sbom-tool "https://github.com/microsoft/sbom-tool/releases/download/v${{ env.MS_SBOM_TOOL_VERSION }}/sbom-tool-linux-x64"
          echo "Verifying sbom-tool download..."
          if [ ! -f sbom-tool ]; then
            echo "Error: sbom-tool download failed"
            exit 1
          fi
          chmod +x sbom-tool

      - name: Generate SBOM
        shell: bash
        run: |
          mkdir -p sbom-output
          ./sbom-tool generate \
            -b sbom-output \
            -bc . \
            -pn "${{ env.TOOL_NAME }}" \
            -pv "${{ env.LATEST_TAG }}" \
            -ps "${{ env.SUPPLIER_NAME }}" \
            -nsb "${{ env.SUPPLIER_URL }}" \
            -cd "--DirectoryExclusionList ${{ env.MS_SBOM_TOOL_EXCLUDE_DIRS }}"

      - name: Print environment variables
        run: |
          echo "=== Environment Variables ==="
          env | sort
          echo "==========================="

      - name: Upload SBOM
        run: |
          python3 pylynk/pylynk.py \
            --verbose upload \
            --prod "${{ env.TOOL_NAME }}" \
            --env "${{ env.SBOM_ENV }}" \
            --sbom "sbom-output/_manifest/spdx_2.2/manifest.spdx.json" \
            --token "${{ secrets.INTERLYNK_SECURITY_TOKEN }}"
